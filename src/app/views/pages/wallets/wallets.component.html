<app-create-wallet-dialog
  [visible]="createWalletDialogVisible()"
  (visibleChange)="handleCreateWalletDialogVisibleChange($event)"
/>

<c-modal
  alignment="center"
  [visible]="detailsVisible()"
  (visibleChange)="handleDetailsVisibleChange($event)"
  size="lg"
>
  <c-modal-header>
    <h5 cModalTitle>Wallet details</h5>
    <button cButtonClose></button>
  </c-modal-header>
  <c-modal-body>
    <div *ngIf="detailsError()" class="alert alert-danger mb-3" role="alert">
      {{ detailsError() }}
    </div>

    <div *ngIf="detailsLoading()" class="d-flex align-items-center gap-2 text-body-secondary">
      <c-spinner size="sm" aria-hidden="true"></c-spinner>
      Loading...
    </div>

    <ng-container *ngIf="!detailsLoading() && selectedWallet() as w">
      <div class="mb-3">
        <div class="fw-semibold">{{ w.name }}</div>
        <div class="text-body-secondary small">
          {{ w.currency }} • Current: {{ w.currentBalance }} • Initial: {{ w.initialBalance }}
        </div>
      </div>

      <hr />

      <div class="mb-2 fw-semibold">Members</div>
      <div *ngIf="!w.members || w.members.length === 0" class="text-body-secondary mb-3">
        No members.
      </div>
      <table *ngIf="w.members && w.members.length > 0" cTable class="table table-sm align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Member</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let m of w.members; let i = index">
            <td>{{ i + 1 }}</td>
            <td>
              <span *ngIf="memberEmailValue(m) as email; else rawMember">{{ email }}</span>
              <ng-template #rawMember>
                <pre class="mb-0 small">{{ m | json }}</pre>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>

      <hr />

      <div class="mb-2 fw-semibold">Add member</div>
      <div *ngIf="addMemberError()" class="alert alert-danger mb-3" role="alert">
        {{ addMemberError() }}
      </div>

      <form [formGroup]="addMemberForm" class="row g-3" novalidate>
        <div class="col-12">
          <label cLabel for="memberEmail">Member email</label>
          <input
            cFormControl
            id="memberEmail"
            type="email"
            formControlName="email"
            placeholder="user@example.com"
            [class.is-invalid]="memberEmail.touched && memberEmail.invalid"
          />
          <c-form-feedback *ngIf="memberEmail.touched && memberEmail.hasError('required')" [valid]="false">
            Email is required.
          </c-form-feedback>
          <c-form-feedback *ngIf="memberEmail.touched && memberEmail.hasError('email')" [valid]="false">
            Enter a valid email.
          </c-form-feedback>
        </div>
      </form>
    </ng-container>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" type="button" (click)="handleDetailsVisibleChange(false)">
      Close
    </button>
    <button
      cButton
      color="primary"
      type="button"
      (click)="submitAddMember()"
      [disabled]="addMemberLoading() || !selectedWallet()"
    >
      <c-spinner *ngIf="addMemberLoading()" size="sm" class="me-2" aria-hidden="true"></c-spinner>
      Add member
    </button>
  </c-modal-footer>
</c-modal>

<c-row>
  <c-col xs="12">
    <c-card class="mb-4">
      <c-card-header class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
          <strong>Wallets</strong>
          <div class="form-check form-switch m-0 d-flex align-items-center gap-2">
            <input class="form-check-input my-0" type="checkbox" role="switch" id="showArchivedSwitch" [checked]="showArchived()" (change)="showArchived.set(!showArchived())">
            <label class="form-check-label text-body-secondary small" for="showArchivedSwitch">Archived</label>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
        <button
           cButton
           color="light"
           variant="outline"
           type="button"
           (click)="refresh()"
           class="mobile-add-btn d-md-none"
           aria-label="New Wallet"
         >
           <svg cIcon name="cilReload"></svg>
         </button>      
           <!-- Mobile: round + button -->
           <button
           cButton
           color="light"
           variant="outline"
           type="button"
           (click)="openCreateWalletDialog()"
           class="mobile-add-btn d-md-none"
           aria-label="New Wallet"
         >
           <svg cIcon name="cilPlus"></svg>
         </button>
        </div>
      </c-card-header>
      <c-card-body>
        <div *ngIf="errorMessage()" class="alert alert-danger mb-3" role="alert">
          {{ errorMessage() }}
        </div>

        <div *ngIf="loading()" class="d-flex align-items-center gap-2 text-body-secondary mb-3">
          <c-spinner size="sm" aria-hidden="true"></c-spinner>
          Loading wallets...
        </div>

        <div *ngIf="filteredWallets().length === 0" class="text-body-secondary">
          No {{ showArchived() ? 'archived' : '' }} wallets found.
        </div>

        <table *ngIf="filteredWallets().length > 0" cTable class="table table-hover align-middle wallet-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Currency</th>
              <th class="text-end">Current Balance</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let w of filteredWallets()">
              <td [attr.data-label]="'Name'" class="wallet-td--name">{{ w.name }}</td>
              <td [attr.data-label]="'Currency'" class="wallet-td--currency">{{ w.currency }}</td>
              <td [attr.data-label]="'Current Balance'" class="wallet-td--balance text-end">{{ w.currentBalance | number:'1.2-2' }}</td>
              <td class="wallet-td--actions text-end">
                <button *ngIf="w.status !== 'ARCHIVED'" cButton color="info" variant="outline" size="xs" class="me-2" type="button" (click)="openDetails(w.id)">
                  <svg cIcon name="cilMagnifyingGlass"></svg>
                </button>
                <button *ngIf="w.status !== 'ARCHIVED' && isOwner(w)" cButton color="danger" variant="outline" size="xs" type="button" (click)="openDelete(w)">
                  <svg cIcon name="cilTrash"></svg>
                </button>
                <button *ngIf="w.status === 'ARCHIVED' && isOwner(w)" cButton color="warning" variant="outline" size="xs" type="button" (click)="unarchive(w.id)" title="Restore Wallet">
                   <svg cIcon name="cilReload"></svg> Restore
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<c-modal [visible]="deleteVisible()" (visibleChange)="handleDeleteVisibleChange($event)" alignment="center">
  <c-modal-header>
    <h5 cModalTitle>Delete Wallet</h5>
    <button cButtonClose></button>
  </c-modal-header>
  <c-modal-body>
    <p>Are you sure you want to delete this wallet?</p>
    <p class="text-body-secondary small">
      If it has transaction history, it will be <strong>archived</strong> instead of permanently deleted.
    </p>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="secondary" (click)="handleDeleteVisibleChange(false)">Cancel</button>
    <button cButton color="danger" (click)="confirmDelete()" [disabled]="deleteLoading()">
       <c-spinner *ngIf="deleteLoading()" size="sm" class="me-2" aria-hidden="true"></c-spinner>
       Delete
    </button>
  </c-modal-footer>
</c-modal>
