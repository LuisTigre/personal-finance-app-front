<c-modal [visible]="visible" (visibleChange)="handleVisibleChange($event)" size="lg" alignment="center">
  <c-modal-header>
    <h5 cModalTitle>Itemize Transaction</h5>
    <button cButtonClose></button>
  </c-modal-header>
  
  <c-modal-body>
    <div *ngIf="error()" class="alert alert-danger">{{ error() }}</div>
    
    <div *ngIf="loading()" class="text-center py-5">
      <c-spinner></c-spinner>
    </div>

    <div *ngIf="!loading() && transaction" [formGroup]="form">
      <!-- Balance Header -->
      <c-card class="mb-3 bg-light border-0">
        <c-card-body class="d-flex justify-content-between align-items-center">
          <div>
            <div class="small text-muted">Total Amount</div>
            <div class="fw-bold fs-5">{{ transaction.amount | number:'1.2-2' }} {{ transaction.currency }}</div>
          </div>
          <div>
            <div class="small text-muted">Allocated</div>
            <div class="fw-bold fs-5 text-success">{{ allocatedTotal() | number:'1.2-2' }}</div>
          </div>
          <div>
            <div class="small text-muted">Remaining</div>
            <div class="fw-bold fs-5" [class.text-danger]="!isBalanced()" [class.text-success]="isBalanced()">
              {{ remaining() | number:'1.2-2' }}
            </div>
          </div>
        </c-card-body>
      </c-card>

      <!-- Items List -->
      <div formArrayName="items">
        <div *ngFor="let control of items.controls; let i = index" [formGroupName]="i" class="split-row row g-2 align-items-center mb-2">
          <div class="col-4 col-sm-4">
            <label *ngIf="i===0" class="form-label small text-muted d-block mb-1">Item Name</label>
            <input cFormControl formControlName="name" placeholder="e.g. Milk" [class.is-invalid]="control.get('name')?.touched && control.get('name')?.invalid">
          </div>
          <div class="col-3 col-sm-3">
            <label *ngIf="i===0" class="form-label small text-muted d-block mb-1">Category</label>
            <input cFormControl formControlName="category" placeholder="Category" [class.is-invalid]="control.get('category')?.touched && control.get('category')?.invalid">
          </div>
          <div class="col-3 col-sm-3">
             <label *ngIf="i===0" class="form-label small text-muted d-block mb-1">Amount</label>
             <input cFormControl type="number" step="0.01" formControlName="amount" [class.is-invalid]="control.get('amount')?.touched && control.get('amount')?.invalid">
          </div>
          <div class="col-2 col-sm-2 text-end">
             <label *ngIf="i===0" class="form-label small text-muted d-block mb-1">&nbsp;</label>
             <button cButton color="danger" variant="ghost" size="sm" (click)="removeItem(i)" [disabled]="items.length <= 1">
               <svg cIcon name="cilTrash"></svg>
             </button>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <button cButton color="light" size="sm" (click)="addItem()">
          <svg cIcon name="cilPlus" class="me-1"></svg> Add Item
        </button>
      </div>

    </div>
  </c-modal-body>

  <c-modal-footer class="justify-content-between">
    <div>
      <button 
        *ngIf="items.length > 0 && !loading()" 
        cButton 
        color="danger" 
        variant="ghost" 
        (click)="resetToSingle()"
      >
        Reset to Single
      </button>
    </div>
    <div class="d-flex gap-2">
      <button cButton color="secondary" variant="ghost" (click)="handleVisibleChange(false)">Cancel</button>
      <button 
        cButton 
        color="primary" 
        (click)="save()" 
        [disabled]="loading() || saving() || !isBalanced() || form.invalid"
      >
        <c-spinner *ngIf="saving()" size="sm"></c-spinner>
        Save Changes
      </button>
    </div>
  </c-modal-footer>
</c-modal>
